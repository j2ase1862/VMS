<UserControl x:Class="VMS.VisionSetup.Views.ToolSettings.ToolSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:controls="clr-namespace:VMS.VisionSetup.Controls"
             xmlns:ts="clr-namespace:VMS.VisionSetup.Views.ToolSettings"
             xmlns:tools="clr-namespace:VMS.VisionSetup.Views.ToolSettings.Tools"
             xmlns:vm="clr-namespace:VMS.VisionSetup.ViewModels.ToolSettings"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="300"
             Background="#2D2D30">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>

        <!-- DataTemplates for each tool ViewModel type -->
        <DataTemplate x:Key="GrayscaleTemplate" DataType="{x:Type vm:GrayscaleToolSettingsViewModel}">
            <tools:GrayscaleToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="BlurTemplate" DataType="{x:Type vm:BlurToolSettingsViewModel}">
            <tools:BlurToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="ThresholdTemplate" DataType="{x:Type vm:ThresholdToolSettingsViewModel}">
            <tools:ThresholdToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="EdgeDetectionTemplate" DataType="{x:Type vm:EdgeDetectionToolSettingsViewModel}">
            <tools:EdgeDetectionToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="MorphologyTemplate" DataType="{x:Type vm:MorphologyToolSettingsViewModel}">
            <tools:MorphologyToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="HistogramTemplate" DataType="{x:Type vm:HistogramToolSettingsViewModel}">
            <tools:HistogramToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="FeatureMatchTemplate" DataType="{x:Type vm:FeatureMatchToolSettingsViewModel}">
            <tools:FeatureMatchToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="BlobTemplate" DataType="{x:Type vm:BlobToolSettingsViewModel}">
            <tools:BlobToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="CaliperTemplate" DataType="{x:Type vm:CaliperToolSettingsViewModel}">
            <tools:CaliperToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="LineFitTemplate" DataType="{x:Type vm:LineFitToolSettingsViewModel}">
            <tools:LineFitToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="CircleFitTemplate" DataType="{x:Type vm:CircleFitToolSettingsViewModel}">
            <tools:CircleFitToolSettings/>
        </DataTemplate>
        <DataTemplate x:Key="HeightSlicerTemplate" DataType="{x:Type vm:HeightSlicerToolSettingsViewModel}">
            <tools:HeightSlicerToolSettings/>
        </DataTemplate>

        <ts:ToolSettingsTemplateSelector x:Key="ToolTemplateSelector"
            GrayscaleTemplate="{StaticResource GrayscaleTemplate}"
            BlurTemplate="{StaticResource BlurTemplate}"
            ThresholdTemplate="{StaticResource ThresholdTemplate}"
            EdgeDetectionTemplate="{StaticResource EdgeDetectionTemplate}"
            MorphologyTemplate="{StaticResource MorphologyTemplate}"
            HistogramTemplate="{StaticResource HistogramTemplate}"
            FeatureMatchTemplate="{StaticResource FeatureMatchTemplate}"
            BlobTemplate="{StaticResource BlobTemplate}"
            CaliperTemplate="{StaticResource CaliperTemplate}"
            LineFitTemplate="{StaticResource LineFitTemplate}"
            CircleFitTemplate="{StaticResource CircleFitTemplate}"
            HeightSlicerTemplate="{StaticResource HeightSlicerTemplate}"/>
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="10">
            <!-- Tool Header -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                <TextBlock Text="{Binding Name}" Foreground="#FFD700"
                           FontWeight="Bold" FontSize="14" VerticalAlignment="Center"/>
                <controls:HelpIcon ToolType="{Binding ToolType}"
                                   Margin="8,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Tool-Specific Parameters via DataTemplateSelector -->
            <ContentControl Content="{Binding}"
                            ContentTemplateSelector="{StaticResource ToolTemplateSelector}"/>

            <!-- Common Settings -->
            <TextBlock Text="Common Settings" Style="{StaticResource SectionHeaderStyle}"/>

            <CheckBox Content="Enabled" IsChecked="{Binding IsEnabled, FallbackValue=True}"
                      Style="{StaticResource SettingCheckBoxStyle}"/>

            <!-- UseROI + ROI Settings: hidden when HasCustomROISection is true -->
            <CheckBox Content="Use ROI" IsChecked="{Binding UseROI, FallbackValue=False}">
                <CheckBox.Style>
                    <Style TargetType="CheckBox" BasedOn="{StaticResource SettingCheckBoxStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasCustomROISection}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </CheckBox.Style>
            </CheckBox>

            <!-- ROI Settings -->
            <StackPanel>
                <StackPanel.Style>
                    <Style TargetType="StackPanel">
                        <Setter Property="Visibility" Value="{Binding UseROI, Converter={StaticResource BoolToVisConverter}, FallbackValue=Collapsed}"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasCustomROISection}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </StackPanel.Style>

                <TextBlock Text="ROI Settings" Style="{StaticResource SectionHeaderStyle}"/>

                <Grid Margin="0,5,0,5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="X:" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,5,5" Grid.Row="0" Grid.Column="0"/>
                    <TextBox Grid.Row="0" Grid.Column="1" Margin="0,0,10,5"
                             Style="{StaticResource SettingTextBoxStyle}"
                             Text="{Binding ROIX, UpdateSourceTrigger=PropertyChanged, FallbackValue=0}"/>

                    <TextBlock Text="Y:" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,5,5" Grid.Row="0" Grid.Column="2"/>
                    <TextBox Grid.Row="0" Grid.Column="3" Margin="0,0,0,5"
                             Style="{StaticResource SettingTextBoxStyle}"
                             Text="{Binding ROIY, UpdateSourceTrigger=PropertyChanged, FallbackValue=0}"/>

                    <TextBlock Text="W:" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,5,5" Grid.Row="1" Grid.Column="0"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Margin="0,0,10,5"
                             Style="{StaticResource SettingTextBoxStyle}"
                             Text="{Binding ROIWidth, UpdateSourceTrigger=PropertyChanged, FallbackValue=0}"/>

                    <TextBlock Text="H:" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,5,5" Grid.Row="1" Grid.Column="2"/>
                    <TextBox Grid.Row="1" Grid.Column="3" Margin="0,0,0,5"
                             Style="{StaticResource SettingTextBoxStyle}"
                             Text="{Binding ROIHeight, UpdateSourceTrigger=PropertyChanged, FallbackValue=0}"/>
                </Grid>

                <StackPanel Orientation="Horizontal" Margin="0,5,0,5">
                    <Button Content="Draw ROI" Command="{Binding DrawROICommand}"
                            Background="#007ACC" Foreground="White" BorderBrush="#005A9E"
                            Padding="10,4" Margin="0,0,10,0" Cursor="Hand"/>
                    <Button Content="Clear ROI" Command="{Binding ClearROICommand}"
                            Background="#555555" Foreground="White" BorderBrush="#444444"
                            Padding="10,4" Cursor="Hand"/>
                </StackPanel>
            </StackPanel>

            <!-- Execution Info -->
            <TextBlock Text="Execution Info" Style="{StaticResource SectionHeaderStyle}"/>

            <TextBlock Style="{StaticResource SettingLabelStyle}">
                <Run Text="Last Execution Time: "/>
                <Run Text="{Binding ExecutionTime, StringFormat='{}{0:F2} ms', FallbackValue='N/A'}"
                     Foreground="#00BFFF" FontWeight="Bold"/>
            </TextBlock>
        </StackPanel>
    </ScrollViewer>
</UserControl>
