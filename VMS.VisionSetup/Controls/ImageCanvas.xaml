<UserControl x:Class="VMS.VisionSetup.Controls.ImageCanvas"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800"
             Background="#1E1E1E"
             ClipToBounds="True">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>

        <!-- Handle Style -->
        <Style x:Key="HandleStyle" TargetType="Ellipse">
            <Setter Property="Width" Value="10"/>
            <Setter Property="Height" Value="10"/>
            <Setter Property="Fill" Value="White"/>
            <Setter Property="Stroke" Value="#00FF00"/>
            <Setter Property="StrokeThickness" Value="2"/>
            <Setter Property="Cursor" Value="SizeAll"/>
        </Style>

        <!-- Rotate Handle Style -->
        <Style x:Key="RotateHandleStyle" TargetType="Ellipse">
            <Setter Property="Width" Value="12"/>
            <Setter Property="Height" Value="12"/>
            <Setter Property="Fill" Value="#FFD700"/>
            <Setter Property="Stroke" Value="#FF8C00"/>
            <Setter Property="StrokeThickness" Value="2"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
    </UserControl.Resources>

    <Grid x:Name="RootGrid">
        <!-- Scroll Viewer for panning -->
        <ScrollViewer x:Name="ImageScrollViewer"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      PanningMode="Both"
                      PreviewMouseWheel="ImageScrollViewer_PreviewMouseWheel">

            <!-- Zoom/Pan Container -->
            <Grid x:Name="ZoomContainer"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center">
                <Grid.LayoutTransform>
                    <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1"/>
                </Grid.LayoutTransform>

                <!-- Image Layer -->
                <Image x:Name="DisplayImage"
                       Stretch="None"
                       RenderOptions.BitmapScalingMode="NearestNeighbor"/>

                <!-- ROI Drawing Canvas (hidden in Result Image mode) -->
                <Canvas x:Name="DrawingCanvas"
                        Background="Transparent"
                        Visibility="{Binding IsROIEditingEnabled, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisConverter}}"
                        MouseLeftButtonDown="Canvas_MouseLeftButtonDown"
                        MouseLeftButtonUp="Canvas_MouseLeftButtonUp"
                        MouseMove="Canvas_MouseMove"
                        MouseRightButtonDown="Canvas_MouseRightButtonDown"/>
            </Grid>
        </ScrollViewer>

        <!-- Toolbar Overlay -->
        <StackPanel Orientation="Horizontal"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Margin="5"
                    Background="#80000000"
                    Visibility="{Binding IsToolbarVisible, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisConverter}}">

            <!-- ROI Tool Buttons -->
            <RadioButton x:Name="SelectToolBtn"
                         Content="Select"
                         Style="{StaticResource {x:Type ToggleButton}}"
                         Foreground="White"
                         Background="#444"
                         Padding="8,4"
                         Margin="2"
                         IsChecked="True"
                         Checked="SelectTool_Checked"/>

            <RadioButton x:Name="RectangleToolBtn"
                         Content="Rectangle"
                         Style="{StaticResource {x:Type ToggleButton}}"
                         Foreground="White"
                         Background="#444"
                         Padding="8,4"
                         Margin="2"
                         Checked="RectangleTool_Checked"/>

            <RadioButton x:Name="RectAffineToolBtn"
                         Content="RectAffine"
                         Style="{StaticResource {x:Type ToggleButton}}"
                         Foreground="White"
                         Background="#444"
                         Padding="8,4"
                         Margin="2"
                         Checked="RectAffineTool_Checked"/>

            <RadioButton x:Name="CircleToolBtn"
                         Content="Circle"
                         Style="{StaticResource {x:Type ToggleButton}}"
                         Foreground="White"
                         Background="#444"
                         Padding="8,4"
                         Margin="2"
                         Checked="CircleTool_Checked"/>

            <RadioButton x:Name="EllipseToolBtn"
                         Content="Ellipse"
                         Style="{StaticResource {x:Type ToggleButton}}"
                         Foreground="White"
                         Background="#444"
                         Padding="8,4"
                         Margin="2"
                         Checked="EllipseTool_Checked"/>

            <RadioButton x:Name="PolygonToolBtn"
                         Content="Polygon"
                         Style="{StaticResource {x:Type ToggleButton}}"
                         Foreground="White"
                         Background="#444"
                         Padding="8,4"
                         Margin="2"
                         Checked="PolygonTool_Checked"/>

            <Separator Margin="5,0"/>

            <!-- Zoom Controls -->
            <Button Content="-" Width="30" Margin="2" Click="ZoomOut_Click" Background="#444" Foreground="White"/>
            <TextBlock x:Name="ZoomLevelText" Text="100%" VerticalAlignment="Center" Foreground="White" Margin="5,0"/>
            <Button Content="+" Width="30" Margin="2" Click="ZoomIn_Click" Background="#444" Foreground="White"/>
            <Button Content="Fit" Width="40" Margin="2" Click="ZoomFit_Click" Background="#444" Foreground="White"/>

            <Separator Margin="5,0"/>

            <!-- ROI Actions -->
            <Button Content="Delete" Margin="2" Click="DeleteROI_Click" Background="#8B0000" Foreground="White" Padding="8,4"/>
            <Button Content="Clear All" Margin="2" Click="ClearAllROI_Click" Background="#444" Foreground="White" Padding="8,4"/>
        </StackPanel>

        <!-- Status Bar -->
        <Border Background="#80000000"
                VerticalAlignment="Bottom"
                HorizontalAlignment="Left"
                Padding="5,2"
                Margin="5"
                Visibility="{Binding IsToolbarVisible, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisConverter}}">
            <TextBlock x:Name="StatusText"
                       Foreground="White"
                       FontSize="11"
                       Text="Ready"/>
        </Border>

        <!-- Coordinate Display -->
        <Border Background="#80000000"
                VerticalAlignment="Bottom"
                HorizontalAlignment="Right"
                Padding="5,2"
                Margin="5"
                Visibility="{Binding IsToolbarVisible, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisConverter}}">
            <TextBlock x:Name="CoordinateText"
                       Foreground="#00FF00"
                       FontSize="11"
                       FontFamily="Consolas"
                       Text="X: 0, Y: 0"/>
        </Border>
    </Grid>
</UserControl>
